language: android

env:
# CODACY_PROJECT_TOKEN token
  - secure: "aQWEOXIfkEC0PHF6j/uEHFyW7tK3eR724FKrWQFZ7h7qjkpBU4fRPkUv15kn3VRXi33bXWFOVcayLXBNF3GPuq2k8BGlQk9mSN2vWc4dZp2RQu8raGXN6680lXD9ERGt3X9RgFiIOZIf4V9fK6KQJpZ/cjFxTZdIE6Rz4ambPnUNafo7S9kR51sQa5N4fg9tmUQT0Iye7KOet0QeBbDAMy6itxzhE2HLw+U1mgMKzMJ4ki1DViHJIxO8lnCSutGqnQj4BpaiSJJBsRmgsHxTtTtUDYgtuJvwYrG04opQhgquKfHWlaA12p3SS7uhwotEj+p3hn62Ht6pRPE8f6NUyN2/3XpEAagLqh+5TiVA5j1lDOdGM8TfVD6KhzGhqdEmQLYfAx+69Zn3xCkP4BZIQv7yKp5UnZT8DHJMAzX3rhsASAsyR0+GkOKzP8gi3U8BYqqzyY54RtjXoVyB4UDa5Tyc5FYIwave9VoQhxz2cRtZBK6Ec7eBBd+LIZWdvvYj5FfPaRjPdtp1DgVxwV/lxKOYr4E4qmvjmJmt1xa07YscvXYVNmvnmpytiSFEaODV5WSg2bW5uM8dF+upvxZRW4IFtD/vSA5uUBFgeATEUx+4OetwmsWMJru9RyRyiVOGngRfAFudnl1wmxm45VHoS2LPQkKxJBxrrcZBtKqQbmg="

before_install:
  - yes | sdkmanager "platforms;android-27"
  - sudo apt-get install jq
  - wget -O ~/codacy-coverage-reporter-assembly-latest.jar $(curl https://api.github.com/repos/codacy/codacy-coverage-reporter/releases/latest | jq -r .assets[0].browser_download_url)

android:
  components:
    - build-tools-27.0.1
    - android-27
  licenses:
    - 'android-sdk-license-.+'

jdk:
    - oraclejdk8

after_success:
  - java -jar ~/codacy-coverage-reporter-assembly-latest.jar report -l Java -r build/reports/jacoco/test/jacocoTestReport.xml

notifications:
    # travis update notifications for email on success and on failure
    email:
      recipients:
        - sophiaquach16@gmail.com
        - jadmalek92@gmail.com
        - amawai.731@gmail.com
        - mnhn329@gmail.com
        - pxaman@gmail.com
        - roger_lu_dude@hotmail.com
        - artemmikhalitsin@gmail.com
      on_success: always
      on_failure: always

jobs:
  # note that the reason for the no language set is an issue with the beta version of the build stages
  # for the android language
  include:
    # will compile build the app's dependencies
    - stage: compile
      language: android
      script: ./gradlew -q app:dependencies --configuration compile
    # will run all tests of the application
    - stage: All Tests
      language: android
      before_script: chmod +x gradlew
      script: ./gradlew testDevDebug
    # will build the release 1 tests added by our team
    - stage: Release 1 Tests
      language: android
      before_script: chmod +x gradlew
      script: ./gradlew -p app/src/test/java/org/wikipedia/feed/onthisday
      script: ./gradlew -p app/src/test/java/org/wikipedia/activity
      script: ./gradlew -p app/src/test/java/org/wikipedia/settings
    # will build the release 2 tests added by our team
    - stage: Release 2 Tests
      language: android
      script: ./gradlew -p app/src/test/java/org/wikipedia/travel
      script: ./gradlew -p app/src/androidTest/java/org/wikipedia/espresso/travel
      script: ./gradlew -p app/src/androidTest/java/org/wikipedia/travel
      # will build the release 3 tests added by our team
    - stage: Release 3 Tests
      language: android
      script: ./gradlew -p app/src/test/java/org/wikipedia/translation
      script: ./gradlew -p app/src/test/java/org/wikipedia/search
      script: ./gradlew -p app/src/androidTest/java/org/wikipedia/page
      script: ./gradlew -p app/src/androidTest/java/org/wikipedia/espresso/privateBrowsing
      script: ./gradlew -p app/src/androidTest/java/org/wikipedia/espresso/articleNote
      script: ./gradlew -p app/src/androidTest/java/org/wikipedia/espresso/translation
    # will inspect deploy build without skipping on tagged commits for releases
    - stage: GitHub Release
      script: echo "Deploying to GitHub releases ..."
      deploy:
        provider: releases
        api_key: "e8c08bbdb7fef2959553f8eb8c2f376135b9ab33"
        skip_cleanup: true
        on:
          tags: true