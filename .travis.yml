language: android

before_install:
  - yes | sdkmanager "platforms;android-27"

android:
  components:
    - build-tools-27.0.1
    - android-27
  licenses:
    - 'android-sdk-license-.+'

jobs:
  # note that the reason for the no language set is an issue with the beta version of the build stages
  # for the android language
  include:
    # will compile build the app's dependencies
    - stage: compile
      language: android
      script: ./gradlew -q app:dependencies --configuration compile
    # will run all tests of the application
    - stage: All Tests
      language: android
      before_script: chmod +x gradlew
      script: ./gradlew testDevDebug
    # will run the release 1 unit tests added by our team
    - stage: Release 1 Unit Tests
      language: android
      before_script: cd app/src/test/java/org/wikipedia/feed/onthisday
      script: ./gradlew testDevDebug
      before_script: cd app/src/test/java/org/wikipedia/activity
      script: ./gradlew testDevDebug
      before_script: cd app/src/test/java/org/wikipedia/settings
      script: ./gradlew testDevDebug
    # will run the release 2 unit tests added by our team
    - stage: Release 2 Unit Tests
      language: android
      before_script: cd app/src/test/java/org/wikipedia/travel
      script: ./gradlew testDevDebug
    # will run the espresso tests added by our team (WILL ADD ONCE ESPRESSO TESTS ARE INTEGRATED INTO DEVELOP BRANCH)
    - stage: Release 2 Espresso Tests
      language: android
      # before_script:
      script: skip
    # will inspect deploy build without skipping on tagged commits for releases
    - stage: GitHub Release
      script: echo "Deploying to GitHub releases ..."
      deploy:
        provider: releases
        api_key: $GITHUB_OAUTH_TOKEN
        skip_cleanup: true
        on:
          tags: true